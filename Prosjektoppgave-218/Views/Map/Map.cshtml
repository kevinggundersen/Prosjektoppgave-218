@{
    ViewData["Title"] = "Kart";
}

<div class="container-fluid" id="mapcontainer">
    <h1></h1>

    <div id="map" style="height: 600px; width: 100%;"></div>
</div>

@section Styles {
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />

    <!-- Leaflet Control Geocoder CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
}

@section Scripts {
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- Leaflet Control Geocoder plugin -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <!-- Proj4 and Proj4Leaflet for reprojecting EPSG:32633 → EPSG:4326 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.js"></script>

    <script>
        // Define UTM zone 33N projection
        proj4.defs("EPSG:32633", "+proj=utm +zone=33 +datum=WGS84 +units=m +no_defs");

        console.log("Map script loaded");

        // Initialize map
        var map = L.map('map').setView([58.1633, 8.0025], 8);

        // Helper for WMS GetFeatureInfo
        function getFeatureInfoUrl(map, latlng, baseUrl, options) {
            const point = map.latLngToContainerPoint(latlng, map.getZoom());
            const size = map.getSize();
            const params = {
                request: 'GetFeatureInfo',
                service: 'WMS',
                srs: 'EPSG:3857',
                styles: '',
                transparent: true,
                version: '1.3.0',
                format: 'image/png',
                bbox: map.getBounds().toBBoxString(),
                height: size.y,
                width: size.x,
                layers: options.layers,
                query_layers: options.query_layers,
                info_format: options.info_format,
                i: Math.floor(point.x),
                j: Math.floor(point.y)
            };
            return baseUrl + L.Util.getParamString(params, baseUrl, true);
        }

        // Base layers
        var kartverket = L.tileLayer('https://cache.kartverket.no/v1/wmts/1.0.0/topo/default/webmercator/{z}/{y}/{x}.png', {
            maxZoom: 19,
            attribution: '&copy; Kartverket'
        }).addTo(map);


        var matrikkelkart = L.tileLayer.wms('https://wms.geonorge.no/skwms1/wms.matrikkelkart', {
            layers: 'Matrikkelkart',
            format: 'image/png',
            transparent: true,
            attribution: '&copy; Kartverket'
        }).addTo(map);

        // Layer control
        var baseMaps = { "Kartverket": kartverket };
        var overlayMaps = {
            "Matrikkelkart": matrikkelkart
        };
        var layerControl = L.control.layers(baseMaps, overlayMaps).addTo(map);

        

        // Flood zones layer with on-the-fly reprojection
        var floodLayer = L.layerGroup().addTo(map);
        layerControl.addOverlay(floodLayer, 'Flomsoner');

        // helper to request only the current bbox
        function loadFloodInView() {
            const b = map.getBounds();
            const sw = b.getSouthWest();
            const ne = b.getNorthEast();

            fetch(`/Map/FloodInView?minx=${sw.lng}&miny=${sw.lat}` +
                `&maxx=${ne.lng}&maxy=${ne.lat}`)
                .then(r => r.json())
                .then(fc => {
                    floodLayer.clearLayers();
                    L.geoJSON(fc, {
                        coordsToLatLng: coords => {
                            var p = proj4('EPSG:32633', 'EPSG:4326', coords);
                            return L.latLng(p[1], p[0]);
                        },
                        style: { color: '#0077be', weight: 2, fillOpacity: 0.4 },
                        onEachFeature: (f, layer) =>
                            layer.bindPopup(`<b>Zone ID:</b> ${f.properties.fid}`)
                    }).addTo(floodLayer);
                })
                .catch(err => console.error('Flood In-View load error', err));
        }

        // load initially
        loadFloodInView();

        // reload each time the user pans or zooms
        map.on('moveend', loadFloodInView);

        // Geocoder control
        var geocoder = L.Control.geocoder({ defaultMarkGeocode: false, placeholder: "Søk..." })
            .addTo(map);
        geocoder.getContainer().setAttribute('title', 'Søk etter steder');
        geocoder.on('markgeocode', function (e) {
            map.setView(e.geocode.center, 16);
            L.marker(e.geocode.center).addTo(map)
                .bindPopup(e.geocode.name).openPopup();
        });

        // (Optional) Your WFS and click‐to‐info code can follow here…
    </script>
}
